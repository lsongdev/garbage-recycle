<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>🚮 垃圾分类查询 🚮</title>

  <style>
    @import url('https://lsong.org/css/stylesheet.css');
    @import url('https://lsong.org/stylesheets/button.css');


    ol#results,
    ul#categories {
      padding: 0;
      margin: 10px auto;
      list-style: none;
    }

    ul#categories li {
      display: flex;
      flex: 1;
      align-items: center;
    }

    ul#categories li h3 {
      margin: 3px;
      font-size: 16px;
    }

    ul#categories li p {
      color: #333;
      margin: 3px;
      font-size: 12px;
    }

    .garbage {
      display: flex;
      line-height: 32px;
      margin: 10px 0;
      padding: 10px;
      background-color: #eee;
    }

    .garbage-name,
    .garbage-category {
      flex: 1;
    }

    .garbage-category {
      text-align: right;
      padding-right: 10px;
    }

    .category-action::before {
      color: green;
      content: '处置建议: ';
    }

    footer {
      color: #999;
      padding: 50px;
    }
  </style>
</head>
<script id="category" type="text/template">
  <li>
    <div>
      <img src=".#{ img }">
    </div>
    <div>
      <h3>#{name}</h3>
      <p>#{content}</p>
      <p>#{description}</p>
      <p class="category-action" >#{action}</p>
    </div>
  </li>
</script>

<script id="result" type="text/template">
  <li class="garbage" style="color: #{category.color}"  >
    <span class="garbage-name" >#{name}</span>
    <span class="garbage-category" style="background-color: #{category.bgcolor}" >#{category.name}</span>
  </li>
</script>


<script id="report" type="text/template">
  <p class="text-center">没找到想要的结果？</p>
  <a class="block text-center" href="https://github.com/song940/garbage-recycle/issues/new?title=#{query}">请提交反馈帮助我们改善数据</a>
</script>

<body>
  <div class="container">

    <header class="header scrollbar-hide">
      <a class="heading" href="/">
        <img src="https://lsong.org/icon.svg" alt="" class="logo" width="24">
        <h1 class="title">Garbage Recycle</h1>
      </a>
      <nav id="navbar" class="nav nav-bar">
        <a href="//lsong.org">home</a>
        <a href="//lsong.org/posts">blog</a>
        <a href="//lsong.org/books">books</a>
        <a href="//lsong.org/music">music</a>
        <a href="//lsong.org/apps">apps</a>
        <x-inbox></x-inbox>
      </nav>
      <hr />
    </header>

    <main class="content">

      <section id="hello"></section>
      <h2>Hello 👋</h2>
      <p class="headline">
        Hi, I'm Liu Song, a full-stack developer with a passion for open-source software.
        I have experience in web and mobile development, as well as a background in embedded systems and network
        protocols.
        I enjoy writing tech <a href="//lsong.org/posts">blogs</a> and developing <a
          href="//lsong.org/apps.html">applications</a> in my spare time.
        Proficient in Node.js, Golang, and server operations, I'm always eager to learn more and contribute to the
        community.
        Check out my GitHub <a href="https://github.com/song940">@song940</a> for some of my projects and feel free
        to connect
        with me to discuss ideas.
        When I'm not coding, I enjoy listening to <a href="//lsong.org/music">music</a> and playing <a
          href="//lsong.org/games">games</a>.
      </p>
      </section>

      <section>
        <h2>Garbage Recycle</h2>
        <form class="input-group width-full">
          <input class="input text-center" type="search" name="q">
          <button class="button button-primary">查询</button>
        </form>
        <ul id="categories"></ul>
        <ol id="results"></ol>
      </section>

    </main>
    <footer class="text-center">
      <a href="https://github.com/song940/garbage-recycle">Garbage Recycle Project at GitHub.com</a>
      <br />Made by <a href="https://lsong.org">Lsong</a> &copy; 2019
    </footer>
  </div>
</body>
<script>

  const parseQueryString = () => {
    const querystring = location.search.slice(1);
    return querystring.split('&').reduce((qs, s) => {
      const [name, value] = s.split('=');
      qs[name] = decodeURIComponent(value);
      return qs;
    }, {});
  };

  const parseCSV = str => {
    const lines = str
      .toString()
      .split(/\r?\n/g);
    const [firstLine] = lines;
    const columns = firstLine.split(',');
    return lines
      .slice(1)
      .map(line => line
        .split(',')
        .reduce((o, p, i) => (o[columns[i]] = p, o), {})
      );
  };

  const get = (o, p) => p.split('.').reduce((o, k) => o && o[k], o);

  const render = (id, data) => {
    const template = document.getElementById(id).innerHTML;
    const div = document.createElement('div');
    div.innerHTML = template.replace(/#{([\s\S]*?)}/g, (_, name) => get(data, name.trim()));
    return div.firstElementChild;
  }

  const fetchCategories = () =>
    fetch('./data/categories.json')
      .then(res => res.json())
      .then(categories => categories.reduce((o, c) => (o[c.id] = c, o), {}))

  const fetchGarbages = () =>
    fetch('./data/garbage.csv')
      .then(res => res.text())
      .then(parseCSV)


  function compareTwoStrings(first, second) {
    if (!first || !second) return 0;
    first = first.replace(/\s+/g, '')
    second = second.replace(/\s+/g, '')

    if (!first.length && !second.length) return 1;           // if both are empty strings
    if (!first.length || !second.length) return 0;           // if only one is empty string
    if (first === second) return 1;       							     // identical
    if (first.length === 1 && second.length === 1) return 0; // both are 1-letter strings
    if (first.length < 2 || second.length < 2) return 0;     // if either is a 1-letter string

    let firstBigrams = new Map();
    for (let i = 0; i < first.length - 1; i++) {
      const bigram = first.substring(i, i + 2);
      const count = firstBigrams.has(bigram)
        ? firstBigrams.get(bigram) + 1
        : 1;

      firstBigrams.set(bigram, count);
    };

    let intersectionSize = 0;
    for (let i = 0; i < second.length - 1; i++) {
      const bigram = second.substring(i, i + 2);
      const count = firstBigrams.has(bigram)
        ? firstBigrams.get(bigram)
        : 0;

      if (count > 0) {
        firstBigrams.set(bigram, count - 1);
        intersectionSize++;
      }
    }

    return (2.0 * intersectionSize) / (first.length + second.length - 2);
  }


  const { q } = parseQueryString();

  const input = document.querySelector('input')
  const results = document.querySelector('#results');
  const categories = document.querySelector('#categories');

  if (q) {
    input.value = q;
    Promise.all([
      fetchCategories(),
      fetchGarbages()
    ]).then(([categories, garbages]) => {
      garbages
        .map(x => (x.score = compareTwoStrings(x.name, q), x))
        .filter(x => x.score)
        .sort((a, b) => b.score - a.score)
        .forEach(item => {
          item.category = categories[item.sortId];
          results.appendChild(render('result', item));
        });
      results.appendChild(render('report', { query: q }));
    });

  } else {
    fetch('./data/categories.json')
      .then(res => res.json())
      .then(list => {
        list.forEach(item => {
          categories.appendChild(render('category', item));
        });
      })
  }
</script>

</html>